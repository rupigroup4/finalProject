<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>IAgent</title>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.js"
            integrity="sha256-BTlTdQO9/fascB1drekrDVkaKd9PkwBymMlHOiG+qLI="
            crossorigin="anonymous"></script>
    <!-- data table -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-lite/1.1.0/material.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.20/css/dataTables.material.min.css">
    <!-- plugins:css -->
    <link href="../vendors/ti-icons/css/themify-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="../vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="../vendors/base/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link href="../css/style.css" rel="stylesheet" />
    <!-- endinject -->
    <link rel="shortcut icon" href="../images/iAgentLogo2b.png" />
    <!--sorting by date format dd/mm/yyyy-->
    <link rel="stylesheet" href="https://cdn.datatables.net/plug-ins/1.10.21/sorting/date-euro.js">
    <script src="../Scripts/loadingScript.js"></script>
    <script>

        var RequestID = null;
        if (localStorage.getItem("Email") == null && sessionStorage.getItem("Email") == null) {
            window.location.href = "Login/login-2.html";
        }
        if (localStorage.getItem('AgentID')) {
            Agent_ID = localStorage.getItem('AgentID');
            Agent_Name = localStorage.getItem('AgentName');
            Gender = localStorage.getItem('gender');

        } else {
            Agent_ID = sessionStorage.getItem('AgentID');
            Agent_Name = sessionStorage.getItem('AgentName');
            Gender = sessionStorage.getItem('gender');
        }
        if (sessionStorage.getItem('firstTime') == "true") {
            window.onload = loading;
            sessionStorage.setItem('firstTime', false);
        }


        $(document).ready(function () {
            
            setTimeout(Check_new_Request, 1000);
            setTimeout(Check_new_message, 1000);
            ajaxCall("GET", "../api/Request/ShowArchives?Agent_ID=" + Agent_ID, "", successShowArchivest, errorShowArchives);
            ajaxCall("GET", "../api/Customer?Agent_ID=" + Agent_ID, "", successCustomer_list, errorCustomer_list);
            ajaxCall("GET", "../api/Request/CountALLRequest?Agent_ID=" + Agent_ID, "", successCountALLRequest, errorCountALLRequest);
            ajaxCall("GET", "../api/Request/ShowAllRequest?Agent_ID=" + Agent_ID, "", successShowALLRequest, errorShowALLRequest);
            ajaxCall("PUT", "../api/Trip/ActiveTrips?Agent_ID=" + Agent_ID, "", successUpDateActiveTrip, errorUpDateActiveTrip); //Active trips
            ajaxCall("GET", "../api/ToDoList?Agent_ID=" + Agent_ID, "", successGETTask_list, errorGETTask_list);
            if (Gender == "נ")
                document.getElementById("profileDropdown").innerHTML = `<img id="profileDropdown_img" class="center" src="../images/PeoplePic/WomenAgent.png" alt="profile" />`;
            else
                document.getElementById("profileDropdown").innerHTML = `<img id="profileDropdown_img" class="center" src="../images/PeoplePic/ManAgent.png" alt="profile" />`;
            document.getElementById("profileDropdown").innerHTML += `<p id="PH_name_agent">שלום, ${Agent_Name}</p>`;
            function successGETTask_list(Task_List) {
                strTask = '<ul id="ul_todolist" dir="rtl" class="d-flex flex-column-reverse todo-list todo-list-custom">';
                for (var i = 0; i < Task_List.length; i++) {
                    if (Task_List[i].Completed == 1) {
                        strTask += `<li class="completed">
                                                              <div class='form-check form-check-flat'>
                                                                <label class='form-check-label'">
                                                                    <input style="" data-idTask='${Task_List[i].TaskID}' class='checkbox' type='checkbox' checked='checked'/>
                                                                    <i class='input-helper' ></i>
                                                                </label>
                                                              </div>
                                                                <div class='text_task form-check form-check-flat'>${Task_List[i].Text}</div>

                                                            <i id="trash_i" data-idTask='${Task_List[i].TaskID}' class='remove ti-trash'></i>
                                                        </li>`;
                    }
                    else {
                        strTask += `<li><div class='form-check form-check-flat'><label class='form-check-label'><input data-idTask='${Task_List[i].TaskID}' class='checkbox' type='checkbox'/> <i class='input-helper'></i></label></div><div class='text_task form-check form-check-flat'>${Task_List[i].Text}</div><i id="trash_i" data-idTask='${Task_List[i].TaskID}' class='remove ti-trash'></i></li>`;

                    }
                }
                strTask += '</ul>';
                document.getElementById('TaskList').innerHTML = strTask;
            }

            function errorGETTask_list(err) {
                console.log(err);
            }

            $('#archives_switch').on('change', function () {
                if (this.checked) {
                    document.getElementById("Request_table_div").style.display = "none";
                    document.getElementById("Archives_table_div").style.display = "block";
                    console.log("צפיה בארכיון")
                }
                else {
                    document.getElementById("Request_table_div").style.display = "block";
                    document.getElementById("Archives_table_div").style.display = "none";

                    console.log(" צפייה בבקשות")

                }
            });

            function successShowArchivest(ArchivestList) {
                strRequest = "";
                for (var i = 0; i < ArchivestList.length; i += 2) {
                    strRequest += `<tr>
                                   <td id='${ArchivestList[i + 1].FirstName} ${ArchivestList[i + 1].SureName}'><img src='${ArchivestList[i + 1].Img}'/></td>
                                   <td id='${ArchivestList[i + 1].FirstName} ${ArchivestList[i + 1].SureName}'>${ArchivestList[i + 1].FirstName} ${ArchivestList[i + 1].SureName}</td>
                                   <td id="td_AttName" data-attractionId=${ArchivestList[i].AttractionID} >${ArchivestList[i].AttractionName}</td>
                                   <td>${ArchivestList[i].Order_date}</td>
                                   <td>${ArchivestList[i].NumTickets}</td>
                                   <td> ${ArchivestList[i].Status}</td>`;

                }
                document.getElementById("ArchivesPH").innerHTML = strRequest;
                $("#Archives_table").DataTable({
                    columnDefs: [{
                        "type": 'date-euro',
                        "targets": 1
                    }],
                    columnDefs: [{
                        "targets": [0],
                        "orderable": false
                    }],
                    "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "הצג הכל"]],
                    "language": {
                        "search": "חיפוש",
                        "lengthMenu": "שורות להצגה _MENU_",
                        "zeroRecords": "אין בקשות בארכיון",
                        "infoFiltered": "",
                        "info": "הצג עמוד _PAGE_ מתוך _PAGES_",
                        "infoEmpty": "",
                        "loadingRecords": "טוען...",
                        "paginate": {
                            "first": "ראשון",
                            "last": "אחרון",
                            "next": "לעמוד הבא",
                            "previous": "לעמוד הקודם"
                        },
                    }
                });
            }
            function errorShowArchives() { alert("error")}

            $('#upload').click(function () {
                var data = new FormData();
                var files = $("#chooseFile").get(0).files;
                // Add the uploaded file to the form data collection
                if (files.length > 0) {
                    for (f = 0; f < files.length; f++) {
                        data.append("Uploadedpdf", files[f]);
                    }
                }

                // Ajax upload
                $.ajax({
                    type: "POST",
                    url: "../Api/pdf/uploadpdf",
                    contentType: false,
                    processData: false,
                    data: data,
                    success: uploadPdfSuccess,
                    error: uploadPdfError
                });

                return false;
            })

         
        });

        function successUpDateActiveTrip(numEffected) {
            console.log(numEffected);
        }

        function errorUpDateActiveTrip() {
            alert("errorUpDateActiveTrip");
        }

        function successCountALLRequest(count) {
            document.getElementById("Request_numPH").innerHTML = count;
        }

        function errorCountALLRequest(err) {
            alert("errorCountALLRequest");
        }

        function uploadPdfSuccess(dataPath) {
            var str = `http://proj.ruppin.ac.il/igroup4/${dataPath}`;

            //להעלות את הניתוב לשרת ולשלוח בסוף נוטיפיקציה
        }
        function uploadPdfError(err) { console.log(err) }

        function Check_new_Request() {
            ajaxCall("GET", "../api/Request/CountNEWRequest?Agent_ID=" + Agent_ID, "", successCountNEWRequest, errorCountNEWRequest)
        }
        function Check_new_message() {
            ajaxCall("GET", "../api/badge/NEWMessage?Agent_ID=" + Agent_ID, "", successGETNEWmessage, errorGETNEWmessage)
        }

        $(document).on('click', '.dropdown-item', function () {
            var customerID = this.getAttribute("data-id");
            console.log(customerID);
            ajaxCall("PUT", "../api/badge/ReadMessage?customerID=" + customerID, "", successReadMessage, errorReadMessage)
        });
        function successReadMessage(id) {
            if (id != 0) {
                console.log("נקרא");
                console.log(id);
                sessionStorage.setItem("customerID_chat", id);
                window.location.href = "Chat/chat.html";
            }
            else alert("error");
        }

        function errorReadMessage() {
            alert("errorReadMessage");
        }
        function successGETNEWmessage(data) {
            console.log(data);
            var str = "";
            if (data.length) {
                document.getElementById("newMesseages_point").style.display = "block";
                for (k of data) {
                    str += `<a id="dropdown_chat_item" class="dropdown-item"  data-id="${k.Id}">
                    <div class="item-thumbnail">
                        <img src="${k.Img}" alt="image" class="profile-pic">
                                </div>
                        <div class="item-content flex-grow">
                            <h6 class="ellipsis font-weight-normal">${k.FirstName} ${k.SureName}</h6>
                            <p class="font-weight-light small-text text-muted mb-0">
                                The meeting is cancelled
                                    </p>
                        </div>
                         </a>`;
                }
                document.getElementById("NEWmessage").innerHTML = str;
                return;
            }
            document.getElementById("newMesseages_point").style.display = "none";
        }
        function errorGETNEWmessage() {
            alert("errorGETNEWmessage");
        }

        function successCountNEWRequest(data) {
            var count = data.length / 2;
            var strNewRequest;
            if (count) {
                document.getElementById("newRequest").style.display = "block";
                document.getElementById("newRequest").innerHTML = count;
                strNewRequest = `<div style="float:right;"><p class="mb-0 font-weight-normal float-left dropdown-header">בקשות חדשות</p></div>`;
                for (var i = 0; i < data.length; i += 2) {
                    strNewRequest += `<a id="dropdown_Status_item" class="dropdown-item" data-name="${data[i].AttractionName}">
                                                             <div class="item-thumbnail">
                                                                   <div class="item-icon bg-primary">
                                                                      <i class="ti-info mx-0"></i>
                                                                    </div>
                                                              </div>
                                                               <div class="item-content">
                                                                       <h6 class="att_name_item font-weight-normal">${data[i].AttractionName}</h6 >
                                                                         <p class="font-weight-light small-text mb-0 text-muted"> ${data[i + 1].FirstName} ${data[i + 1].SureName}
                                                                         </p>
                                                               </div></a >`;
                }
                document.getElementById("NewReqMenu").innerHTML = strNewRequest;
                return;
            }
            document.getElementById("newRequest").style.display = "none";
        }

        function errorCountNEWRequest(err) {
            alert("errorCountNEWRequest");
        }

        function Moveto_login() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = "Login/login-2.html";
        }

        function successCustomer_list(customers_list) {
            CustomerList = customers_list;
            document.getElementById("customers_numPH").innerHTML = customers_list.length;
            ajaxCall("GET", "../api/Trip?Agent_ID=" + Agent_ID, "", successGETTrip_list, errorGETTrip_list);

        }

        function errorCustomer_list(err) {
            alert("errorCustomer_list");

        }

        function successGETTrip_list(trip_list) {
            var num_day_in_trip;
            var num_day_passed;
            var percent = 100;
            if (trip_list.length == 0) {
                document.getElementById("NumberOfCutomersOnTripPH").innerHTML = 0;
                return;
            }
            else {
                let strCustomerOnTrip = "";
                let countInTrip = 0;
                for (var i = 0; i < trip_list.length; i++) {
                    var dateFrom = trip_list[i].DepartDate;
                    var dateTo = trip_list[i].ReturnDate;

                    var d1 = dateFrom.split("/");
                    var d2 = dateTo.split("/");
                    var from = new Date(d1[2], parseInt(d1[1]) - 1, d1[0]); // -1 because months are from 0 to 11
                    var to = new Date(d2[2], parseInt(d2[1]) - 1, d2[0]);

                    var today = new Date();
                    var dd = today.getDate();
                    var mm = today.getMonth() + 1;
                    var yyyy = today.getFullYear();
                    var today = new Date(yyyy, mm - 1, dd);
                    var color_class;
                    if (today >= from && today <= to) {
                        num_day_in_trip = (to.getTime() - from.getTime()) / (1000 * 3600 * 24) + 1;
                        if (num_day_in_trip == (today.getTime() - from.getTime()) / (1000 * 3600 * 24)) num_day_passed = (today.getTime() - from.getTime()) / (1000 * 3600 * 24);
                        else num_day_passed = (today.getTime() - from.getTime()) / (1000 * 3600 * 24) + 1;
                        percent = Math.round((num_day_passed / num_day_in_trip) * 100);

                        countInTrip++;
                        strCustomerOnTrip += `<tr class='tr_search' id='${trip_list[i + 1].FirstName} ${trip_list[i + 1].SureName}' ><td><img src='${trip_list[i + 1].Img}' /> </td>`;
                        strCustomerOnTrip += "<td>" + trip_list[i + 1].FirstName + " " + trip_list[i + 1].SureName + "</td>";
                        strCustomerOnTrip += "<td>" + trip_list[i].Destination + "</td>";
                        strCustomerOnTrip += "<td>" + trip_list[i].ReturnDate + "</td>";

                        if (percent < 33) color_class = 'success'
                        else if (percent >= 33 && percent < 66) color_class = 'warning'
                        else color_class = 'danger'

                        strCustomerOnTrip += `<td style="min-width: 100px;">
                                                                     ${percent}% <div dir="ltr" class="progress">
                                                                         <div class="progress-bar bg-${color_class}" role="progressbar" style="width: ${percent}%" aria-valuenow="75" aria-valuemin="${num_day_passed}" aria-valuemax="${num_day_in_trip}"></div>
                                                                      </div>
                                                                  </td></tr>`;
                    }
                    i = i + 2;
                }
                document.getElementById("NumberOfCutomersOnTripPH").innerHTML = countInTrip;
                document.getElementById("CustomerOnTripPH").innerHTML = strCustomerOnTrip;
                $("#Table_CustomerOnTrip").DataTable({
                    columnDefs: [{
                        "targets": [0, 4],
                        "orderable": false
                    }],
                    "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "הצג הכל"]],
                    "language": {
                        "search": "חיפוש",
                        "lengthMenu": "שורות להצגה _MENU_",
                        "zeroRecords": "אין טיולים בחול ",
                        "infoFiltered": "",
                        "info": "הצג עמוד _PAGE_ מתוך _PAGES_",
                        "infoEmpty": "",
                        "loadingRecords": "טוען...",
                        "paginate": {
                            "first": "ראשון",
                            "last": "אחרון",
                            "next": "לעמוד הבא",
                            "previous": "לעמוד הקודם"
                        },
                    }

                });
            }
        }

        $(document).on('click', '.tr_search, .td_search', function () {
            var name = this.id;
            sessionStorage.setItem("customerName_click", name);
            window.location.href = "Att_Cust/trips.html";
        });


        function errorGETTrip_list(err) {
            alert("errorGETTripr_list");
        }

        $(document).on("click", "#td_AttName", function () {
            let attId = this.getAttribute('data-attractionId');
            urlResults = "https://www.triposo.com/api/20200405/poi.json?id=" + attId + "&fields=properties&order_by=-score&count=20&account=6B5J2SIO&token=hgiq3zyo304rc0p3kfkh19zd224lunxh";
            console.log(urlResults)
            $.get(urlResults).done(successSpecificWebsite);
            $.get(urlResults).fail(errorSpecificWebsite);
        })

        function successSpecificWebsite(properties) {
            let props = properties.results[0].properties;
            console.log(props)
            for (var i = 0; i < props.length; i++) {
                if (props[i].key == "website") {
                    window.open(props[i].value, '_blank');
                    //window.location.href= props[i].value
                }
            }

        }
        function errorSpecificWebsite(err) {
            console.log(err)
        }

        function successShowALLRequest(Request_customer_list) {
            console.log(Request_customer_list);
            strRequest = "";
            var countSuccess = 0;
            for (var i = 0; i < Request_customer_list.length; i += 2) {
                if (Request_customer_list[i].Status == "success") {
                    countSuccess++;
                }
                let IdRequest = "Row-Request" + Request_customer_list[i].Id + "";
                strRequest += `<tr id='${IdRequest}'>
                                                                   <td class='td_search' id='${Request_customer_list[i + 1].FirstName} ${Request_customer_list[i + 1].SureName}'><img src='${Request_customer_list[i + 1].Img}'/></td>
                                                                   <td class='td_search' id='${Request_customer_list[i + 1].FirstName} ${Request_customer_list[i + 1].SureName}'>${Request_customer_list[i + 1].FirstName} ${Request_customer_list[i + 1].SureName}</td>
                                                                   <td id="td_AttName" data-attractionId=${Request_customer_list[i].AttractionID} >${Request_customer_list[i].AttractionName}</td>
                                                                    <td>${Request_customer_list[i].Order_date}</td>
                                                                    <td>${Request_customer_list[i].NumTickets}</td>`;
                strRequest += '<td><div class="input-group-prepend">';
                switch (Request_customer_list[i].Status) {
                    case "new": strRequest += '<button id="dropdown_Status" class="btn btn-sm btn-outline-primary dropdown-toggle min-btn-index" type ="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >' + Request_customer_list[i].Status + '</button >';
                        break;
                    case "in process": strRequest += '<button id="dropdown_Status" class="btn btn-sm btn-outline-warning dropdown-toggle  min-btn-index" type ="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >' + Request_customer_list[i].Status + '</button >';
                        break;
                    case "success": strRequest += '<button id="dropdown_Status" class="btn btn-sm btn-outline-success dropdown-toggle  min-btn-index" type ="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >' + Request_customer_list[i].Status + '</button >';
                        break;
                    default: strRequest += '<button id="dropdown_Status" class="btn btn-sm btn-outline-danger dropdown-toggle  min-btn-index" type ="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" >' + Request_customer_list[i].Status + '</button >';
                }
                strRequest += '<div class="dropdown-menu" x-placement="bottom-start" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(0px,46px,0px);">';
                let dataRequest = "data-RequestId='" + Request_customer_list[i].Id + "'";
                let dataStatus = "data-Status='" + Request_customer_list[i].Status + "'";
                strRequest += `<a class="dropdown-item" onclick="Change_status('new',${Request_customer_list[i].Id},${Request_customer_list[i + 1].Id},'${Request_customer_list[i].AttractionID}')" >new</a>
                                                <a class="dropdown-item" onclick="Change_status('in process',${Request_customer_list[i].Id},${Request_customer_list[i + 1].Id},'${Request_customer_list[i].AttractionID}')">in prosess</a>
                                                <a class="dropdown-item"  onclick="Change_status('success',${Request_customer_list[i].Id},${Request_customer_list[i + 1].Id},'${Request_customer_list[i].AttractionID}')" >success</a>
                                                <a class="dropdown-item" onclick="Change_status('failed',${Request_customer_list[i].Id},${Request_customer_list[i + 1].Id},'${Request_customer_list[i].AttractionID}')">failed</a></div></div></td>`;
                if (Request_customer_list[i].AttractionID == "lupa") {
                    strRequest += `<td><div id="download-${Request_customer_list[i].Id}" class="upload-btn-wrapper"> <button onclick="downloadAlbum(${Request_customer_list[i].TripID})" class="btn btn-inverse-primary btn-fw"> <i class="ti-import"></i> הורד אלבום </button>
                                    </div></td>`;
                } else if (Request_customer_list[i].Status == 'success') {
                    strRequest += `<td><div id="upload-${Request_customer_list[i].Id}" class="upload-btn-wrapper">  <button onclick="Check_Status()" ${dataRequest} class="btn btn-inverse-warning btn-fw">בחר קובץ</button>
                                            <input ${dataStatus} class="selectedFile" type="file" name="myfile" id ="chooseFile${Request_customer_list[i].Id}"/></div></td>`;
                } else {
                    strRequest += `<td><div id="upload-${Request_customer_list[i].Id}" class="upload-btn-wrapper">  <button onclick="Check_Status()" ${dataRequest} class="btn btn-inverse-warning btn-fw">בחר קובץ</button>
                                            <input ${dataStatus} class="selectedFile" type="file" name="myfile" id ="chooseFile${Request_customer_list[i].Id}"/></div></td>`;
                }
                strRequest += `<td><button onclick="move_to_archives(${Request_customer_list[i].Id},${Request_customer_list[i + 1].Id})" type="button" class="btn btn-inverse-dark btn-icon"><i class="ti-trash"></i></button></td>`;
                var pdf = Request_customer_list[i].PdfFile;
                if (pdf != "") {
                    var pdf_Arr = pdf.split('pdfFiles/');
                    strRequest += `<div class="fileName" id="choosedFile${Request_customer_list[i].Id}">${pdf_Arr[1]}</div></td></tr>`;

                } else {
                    strRequest += `<div class="fileName" id="choosedFile${Request_customer_list[i].Id}"></div></td></tr>`;
                }
            }
            document.getElementById("requestPH").innerHTML = strRequest;
            document.getElementById("AmountOfSalesPH").innerHTML = countSuccess;
            $("#Request_table").DataTable({
                columnDefs: [{
                    "type": 'date-euro',
                    "targets": 1
                }],
                columnDefs: [{
                    "targets": [0, 6, 7],
                    "orderable": false
                }],
                "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "הצג הכל"]],
                "language": {
                    "search": "חיפוש",
                    "lengthMenu": "שורות להצגה _MENU_",
                    "zeroRecords": "אין בקשות במערכת",
                    "infoFiltered": "",
                    "info": "הצג עמוד _PAGE_ מתוך _PAGES_",
                    "infoEmpty": "",
                    "loadingRecords": "טוען...",
                    "paginate": {
                        "first": "ראשון",
                        "last": "אחרון",
                        "next": "לעמוד הבא",
                        "previous": "לעמוד הקודם"
                    },
                }

            });
            if (sessionStorage.getItem('dropdown_ATT_Name')) {
                var Att_name = sessionStorage.getItem('dropdown_ATT_Name')
                sessionStorage.removeItem('dropdown_ATT_Name');

                var table = $('#Request_table').DataTable();
                table.search(Att_name).draw();
                //setTimeout(function () {table.search("").draw();}, 5000);
            }
        }

        $(document).on("click", ".selectedFile", function () {
            if (this.getAttribute('data-Status') != 'success') {
                swal("ראשית עליך לשנות את הסטאטוס לsuccess", "", "error");
                return false;
            } else {
                selectedRequest = this.getAttribute('data-RequestId');
                var data = new FormData();
                var files = $("#chooseFile" + selectedRequest).get(0).files;

                if (files.length > 0) {
                    for (f = 0; f < files.length; f++) {
                        data.append(`${selectedRequest}`, files[f]);
                    }
                }

                // Ajax upload
                $.ajax({
                    type: "POST",
                    url: "../../Api/pdf/uploadpdf",
                    contentType: false,
                    processData: false,
                    data: data,
                    success: SavePdfSuccess,
                    error: SavedPdfError
                });

                return false;
            }
        })

        function SavePdfSuccess(dataPath) {
            let arr = dataPath[0].split('!');

            ajaxCall("POST", "../api/Request/Add_pdf_AttractionTicket?id=" + arr[0] + "&pdf=" + arr[1], {}, POSTsuccessAddPDF, POSTerrorAddPDF);

        }

        function SavedPdfError(err) {
            alert("SavedPdfError")
        }
        function POSTsuccessAddPDF(pdf) {
            if (pdf != "") {
                var pdf_Arr = pdf.split('pdfFiles/');
                document.getElementById("choosedFile" + selectedRequest).innerHTML = pdf_Arr[1];
            }
            else
                alert("error");
        }
        function POSTerrorAddPDF(err) {
            alert("POSTerrorAddPDF");
        }



        function errorShowALLRequest(err) {
            alert("errorRequest_list");
        }

        function downloadAlbum(tripID) {
            ajaxCall("GET", "../api/Request/GetAlbum?TripID=" + tripID, "", successGetAlbum, errorGetAlbum);
        }

        function successGetAlbum(data) {
            console.log(data);
            for (var i = 0; i < data.length; i++) {
                download(data[i], "download1.jpg", "image/jpeg")
                var link = window.URL.createObjectURL(data[i]);
                window.location = link;
            }
        }


        function errorGetAlbum() { swal("successGetAlbum") }

        $(document).on('click', '#dropdown_Status_item', function () {
            var Att_name = this.getAttribute('data-name');
            var input_AttName = document.getElementById('Request_table_filter').childNodes[0].childNodes[1];
            var table = $('#Request_table').DataTable();
            table.search(Att_name).draw();
            setTimeout(function () {
                table.search("").draw();
            }, 5000);
        });



        function errorCustomer_Request(err) {
            alert("errorCustomerRequest_list");
        }


        function Change_status(status, RequestID, Customer_Id, Attraction_ID) {
            ajaxCall("PUT", "../api/Request?status=" + status + "&RequestID=" + RequestID + "&Customer_Id=" + Customer_Id, "", successChange_status, errorChange_status)
            if (status == "success" && Attraction_ID != 'lupa') {
                ajaxCall("PUT", "../api/Promotion?attraction_ID=" + Attraction_ID, "", successIncrease_QuantityOrder, errorIncrease_QuantityOrder)
            }
        }

        function successChange_status(RequestId) { //שלב ראשון לאחר השינוי בדאטה בייס הוא להביא את הקוד אליו נשלח את ההתראה
            //swal("הסטטוס שונה", "", "sucess");
            RequestID = RequestId;
            ajaxCall('GET', `../api/notification/getpntoken/${RequestID}`, "", getPnTokenSucess, getPnTokenError);
        }

        function errorChange_status() {
            alert("errorChange_status");
        }

        function successIncrease_QuantityOrder(num) {
            if (num == 1) {
                console.log("גדל ב1")
            }
            else {
                console.log("אטרקציה זו לא קודמה")
            }
        }

        function errorIncrease_QuantityOrder() {
            alert("errorChange_status");
        }

        function getPnTokenSucess(pnToken) { // אחרי שקיבלנו את קוד אליו נשלח את ההתראה נבצע את השליחה
            //Push realTime notification
            const message = {
                to: pnToken,
                sound: 'default',
                title: 'התקבלה התראה חדשה',
                body: 'היי, יש לי חדשות עבורך',
                data: { RequestId: RequestID },
                _displayInForeground: true,
            }; //בניית ההתראה

            $.ajax({
                type: "POST",
                url: "https://cors-anywhere.herokuapp.com/https://exp.host/--/api/v2/push/send",
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify(message),
                success: successfullySentMessage,
                error: sendingMessageFailed
            });

            //Push realTime notification
        }

        function getPnTokenError(err) {
            //להוסיף פה הודעת שגיאה על שלא התקבל PnToken
            console.log("getPnTokenError");
        }

        function successfullySentMessage(data) {
            window.location.reload();
        }

        function sendingMessageFailed(err) {
            console.log('err= ', err);
        }

        function removeTask(taskID) {

            ajaxCall("DELETE", "../api/ToDoList?taskID=" + taskID, "", DELETEsuccessTask, DELETEerrorTask);
        }

        function updateTask(taskID, Agent_ID, completed) {
            ajaxCall("PUT", "../api/ToDoList?taskID=" + taskID + "&agent_ID=" + Agent_ID + "&completed=" + completed, "", PUTsuccessTask, PUTEerrorTask);

        }

        function PUTsuccessTask(num) {
            if (num == 1) {
                console.log("עודכן");
            }
            else alert("לא עודכן")
        }

        function PUTEerrorTask(err) {
            alert(PUTEerrorTask);
        }

        function DELETEsuccessTask(num) {
            if (num != 1) {
                alert("לא נמחק")
            }
            else console.log("נמחק")
        }

        function DELETEerrorTask(err) {
            alert(DELETEerrorTask);
        }
        function sendTask(TextTask) {
            text = TextTask;
            newTask = {
                "Text": text,
                "Agent_ID": Agent_ID,
            }
            let obj = JSON.stringify(newTask);

            ajaxCall("POST", "../api/ToDoList", obj, POSTsuccessNewTask, POSTerrorNewTask);
            return false;
        }


        text_input_todolist = "";
        (function ($) {
            'use strict';
            $(function () {
                var todoListItem = $('.todo-list');

                var todoListInput = $('.todo-list-input');
                $('.todo-list-add-btn').on("click ", function (event) {
                    event.preventDefault();
                    text_input_todolist = $(this).prevAll('.todo-list-input').val();
                    if (text_input_todolist) {
                        sendTask(text_input_todolist);
                        todoListInput.val("");
                    }
                });
                $('.todo-list-input').on("keyup ", function (event) {
                    if (event.keyCode === 13) {
                        text_input_todolist = $('.todo-list-input').val();
                        if (text_input_todolist) {
                            sendTask(text_input_todolist);
                            todoListInput.val("");
                        }
                    }
                });
                $(document).on('change', '.checkbox', function () {
                    var idTask = this.getAttribute('data-idTask');
                    if ($(this).attr('checked')) {
                        $(this).removeAttr('checked');
                        updateTask(idTask, Agent_ID, 0);
                    } else {
                        $(this).attr('checked', 'checked');
                        updateTask(idTask, Agent_ID, 1);
                    }
                    $(this).closest("li").toggleClass('completed');

                });

                $(document).on('click', '.remove', function () {
                    $(this).parent().remove();
                    var idTask = this.getAttribute('data-idTask');
                    removeTask(idTask);
                });

            });
        })(jQuery);

        function POSTsuccessNewTask(taskID) {
            document.getElementById('ul_todolist').innerHTML += `<li><div class='form-check form-check-flat'><label class='form-check-label'><input data-idTask='${taskID}' class='checkbox' type='checkbox'/><i class='input-helper'></i></label></div>  <div class='text_task form-check form-check-flat'>${text_input_todolist}</div><i id="trash_i" data-idTask='${taskID}' class='remove ti-trash'></i></li>`;
        }

        function POSTerrorNewTask(err) {
            swal("POSTerrorNewTask");
        }

        function move_to_archives(Req_Id, Customer_Id) {
            idRowReq = 'Row-Request' + Req_Id;
            Req_ID = Req_Id;
            Customer_ID = Customer_Id;
            DeleteOrNot();

        }

        function DeleteOrNot() {
            Swal.fire({
                title: 'למחוק את הבקשה?',
                text: "הבקשה תועבר לארכיון ולא ניתן יהיה לצפות בה",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'כן, מחק!',
                cancelButtonText: 'בטל'
            }).then((result) => {
                if (result.value) {
                    $(`#${idRowReq}`).remove();
                    ajaxCall("PUT", "../api/Request?RequestID=" + Req_ID + "&CustomerID=" + Customer_ID, "", success_Archives, error_Archives) //Remove reqeust from Request Table and move to archives.
                }
            });
        }


        function success_Archives(numAff) {
            if (numAff == 1) {
                console.log("Done");
            }
        }
        function error_Archives(err) {
            alert(err);
        }
    </script>
</head>

<body dir="rtl">
    <div class="container-scroller ">
        <!-- partial:partials/_navbar.html -->
        <nav class="navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-center">
                <a class="navbar-brand brand-logo mr-5" href="index.html"><img src="../images/logo_iAgent_png.png" class="mr-2" alt="logo" /></a>
                <a class="navbar-brand brand-logo-mini" href="index.html"><img src="../images/logo_mini_iAgent.png" /></a>

            </div>
            <div class="navbar-menu-wrapper d-flex align-items-center justify-content-end">
                <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                    <span class="ti-view-list"></span>
                </button>
                <ul id="nav_open" class="navbar-nav navbar-nav-right">
                    <li class="nav-item dropdown mr-1">
                        <a class="nav-link count-indicator dropdown-toggle d-flex justify-content-center align-items-center" id="messageDropdown" href="#" data-toggle="dropdown">
                            <span class="count" id="newMesseages_point"></span>
                            <i class="ti-email mx-0"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="messageDropdown">
                            <div style="float:right;"><p class="mb-0 font-weight-normal float-left dropdown-header">הודעות צאט</p></div>
                            <div dir="ltr" id="NEWmessage"></div>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-toggle="dropdown">
                            <i class="ti-bell mx-0"></i>
                            <p class="count" id="newRequest" style="display: none;"></p>
                        </a>
                        <div dir="ltr" id="NewReqMenu" class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="notificationDropdown">
                        </div>
                    </li>
                    <li class="nav-item nav-profile dropdown">
                        <a class="nav-link dropdown-toggle" href="#" data-toggle="dropdown" id="profileDropdown">
                        </a>
                        <div class="dropdown-menu dropdown-menu-right navbar-dropdown" aria-labelledby="profileDropdown">
                            <a class="dropdown-item" onclick="Moveto_login()">
                                התנתקות
                                <i class="ti-power-off text-primary"></i>
                            </a>
                        </div>
                    </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
                    <span class="ti-view-list"></span>
                </button>
            </div>
        </nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
                <ul class="nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="ti-shield menu-icon"></i>
                            <span class="menu-title"> מסך הבית</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-toggle="collapse" href="#ui-basic" aria-expanded="false" aria-controls="ui-basic">
                            <i class="ti-user menu-icon"></i>
                            <span class="menu-title">לקוחות</span>
                            <i dir="rtl" class="menu-arrow" style="transform: rotate(90deg);-webkit-transform: rotate(180deg)"></i>
                        </a>
                        <div class="collapse" id="ui-basic">
                            <ul class="nav flex-column sub-menu">

                                <li class="nav-item"> <a class="nav-link" href="Add_customer/add_customer.html">לקוח חדש</a></li>
                                <li class="nav-item"> <a class="nav-link" href="Att_Cust/customer_list.html">רשימת לקוחות</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Att_Cust/trips.html">
                            <i class="ti-direction-alt menu-icon"></i>
                            <span class="menu-title">טיולים</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Att_Cust/attractions.html">
                            <i class="ti-pin2 menu-icon"></i>
                            <span class="menu-title">אטרקציות</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="Chat/chat.html">
                            <i class="ti-comment menu-icon"></i>
                            <span class="menu-title">צ'אט</span>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- partial -->
            <div class="main-panel">
                <div class="content-wrapper">
                    <div class="row">
                        <div class="col-md-3 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <p class="  card-title text-md-center text-xl-right">עסקאות שהושלמו</p>
                                    <div class="d-flex flex-wrap justify-content-between justify-content-md-center justify-content-xl-between align-items-center">
                                        <h3 id="AmountOfSalesPH" class="stat-count mb-0 mb-md-2 mb-xl-0 order-md-1 order-xl-0"></h3>
                                        <i class="ti-ticket icon-md text-muted mb-0 mb-md-3 mb-xl-0"></i>
                                    </div>
                                    <!--<p class="mb-0 mt-2 text-danger">0.12% <span class="text-black ml-1"><small>(30 days)</small></span></p>-->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <p class="  card-title text-md-center text-xl-right">לקוחות רשומים</p>
                                    <div class="d-flex flex-wrap justify-content-between justify-content-md-center justify-content-xl-between align-items-center">
                                        <h3 id="customers_numPH" class="stat-count mb-0 mb-md-2 mb-xl-0 order-md-1 order-xl-0"></h3>
                                        <i class="ti-user icon-md text-muted mb-0 mb-md-3 mb-xl-0"></i>
                                    </div>
                                    <!--<p class="mb-0 mt-2 text-danger">0.47% <span class="text-black ml-1"><small>(30 days)</small></span></p>-->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <p class="  card-title text-md-center text-xl-right">שוהים בחו"ל</p>
                                    <div class="d-flex flex-wrap justify-content-between justify-content-md-center justify-content-xl-between align-items-center">
                                        <h3 id="NumberOfCutomersOnTripPH" class="stat-count mb-0 mb-md-2 mb-xl-0 order-md-1 order-xl-0"></h3>
                                        <i class="ti-world icon-md text-muted mb-0 mb-md-3 mb-xl-0"></i>
                                    </div>
                                    <!--<p class="mb-0 mt-2 text-success">64.00%<span class="text-black ml-1"><small>(30 days)</small></span></p>-->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <p class="  card-title text-md-center text-xl-right">סה"כ בקשות</p>
                                    <div class="d-flex flex-wrap justify-content-between justify-content-md-center justify-content-xl-between align-items-center">
                                        <h3 id="Request_numPH" class="stat-count mb-0 mb-md-2 mb-xl-0 order-md-1 order-xl-0"></h3>
                                        <i class="ti-files icon-md text-muted mb-0 mb-md-3 mb-xl-0"></i>
                                    </div>
                                    <!--<p class="mb-0 mt-2 text-success">23.00%<span class="text-black ml-1"><small>(30 days)</small></span></p>-->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 grid-margin stretch-card">
                            <div class="card position-relative">
                                <div class="card-body">
                                    <h4 class="card-title">רשימת בקשות</h4>
                                    <p class="card-description archives">
                                        <span style="vertical-align:-4px">
                                            צפייה בארכיון
                                        </span>
                                        <label class="switch">
                                            <input id="archives_switch" type="checkbox">
                                            <span class="slider round"></span>
                                        </label>
                                    </p>
                                    <div class="table-responsive pt-3" id="Request_table_div">
                                        <table class="table mdl-data-table" style="width:100%" id="Request_table">
                                            <thead>
                                                <tr>
                                                    <th>תמונה</th>
                                                    <th>שם הלקוח</th>
                                                    <th>שם אטרקציה</th>
                                                    <th>הזמנה לתאריך</th>
                                                    <th>כמות כרטיסים</th>
                                                    <th>Status</th>
                                                    <th>כרטיסים</th>
                                                    <th>ארכיון</th>
                                                </tr>
                                            </thead>
                                            <tbody id="requestPH"></tbody>
                                        </table>
                                    </div>
                                    <div class="table-responsive pt-3" id="Archives_table_div">
                                        <table class="table mdl-data-table" style="width:100%" id="Archives_table">
                                            <thead>
                                                <tr>
                                                    <th>תמונה</th>
                                                    <th>שם הלקוח</th>
                                                    <th>שם אטרקציה</th>
                                                    <th>הזמנה לתאריך</th>
                                                    <th>כמות כרטיסים</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ArchivesPH"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row" dir="rtl">
                        <div class="col-lg-6 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">לקוחות בחול</h4>
                                    <div class="table-responsive table_trips">
                                        <table  id="Table_CustomerOnTrip" class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th></th>
                                                    <th>שם לקוח</th>
                                                    <th>יעד</th>
                                                    <th>תאריך חזרה</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody id="CustomerOnTripPH"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">To Do Lists</h4>
                                    <div id="TaskList" class="list-wrapper pt-2">
                                    </div>
                                    <div class="add-items d-flex mb-0 mt-4">
                                        <input id="TaskText" type="text" class="form-control todo-list-input mr-2" placeholder="הוסף משימה חדשה">
                                        <button class="add btn btn-icon text-primary todo-list-add-btn bg-transparent"><i class="ti-location-arrow"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- partial:partials/_footer.html -->
                    <!-- partial -->
                </div> <footer class="footer">
                    <div class="d-sm-flex justify-content-center justify-content-sm-between">
                        <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">iAgent System | © 2020 | All rights reserved</span>
                        <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Hand-crafted & made By igroup4_2020 <i class="ti-heart text-danger ml-1"></i></span>
                    </div>
                    <div id="albumImages" hidden></div>
                </footer>
                <!-- main-panel ends -->
            </div>
            <!-- page-body-wrapper ends -->
        </div>
        <!-- container-scroller -->
        <!-- plugins:js -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
        <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
        <script src="../vendors/base/vendor.bundle.base.js"></script>
        <!-- endinject -->
        <!-- Plugin js for this page-->
        <script src="../vendors/chart.js/Chart.min.js"></script>
        <script src="../vendors/chart.js/Chart.min.js"></script>
        <!-- End plugin js for this page-->
        <!-- inject:js -->
        <script src="../js/off-canvas.js"></script>
        <script src="../js/hoverable-collapse.js"></script>
        <script src="../js/template.js"></script>
        <!--<script src="../js/todolist.js"></script>-->
        <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
        <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
        <!-- Custom js for this page-->
        <script src="../js/dashboard.js"></script>
        <!-- End custom js for this page-->
        <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.10.20/js/dataTables.bootstrap4.min.js"></script>

    </div>
</body>

</html>

